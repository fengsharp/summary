1. config
```sh
apt install -y zlib1g-dev
apt install libpq-dev
apt install postgresql-client-12

./configure --prefix=/opt/openresty\
             --with-luajit\
             --without-http_redis2_module \
             --with-http_iconv_module \
             --with-http_postgres_module

```

2. make & make install
3. 打开文件 /etc/profile 末尾加入 export PATH=$PATH:/opt/openresty/nginx/sbin 
4. source /etc/profile

5. vi ~/.bashrc export PATH=$PATH:/opt/openresty/nginx/sbin  source ~/.bashrc
6. mkdir ~/test/config ~/test/logs
7. cd ~/test
8. nginx -p .
9. nginx -p . -s reload



http://192.168.37.85:6699/

psql -h 172.16.0.236 -U ssotest -d sso -p 21001


# demo01
init
```
location / {
    default_type text/html;
    content_by_lua_block {
        ngx.say("hello, lua");
    }
}
```

# demo02
call location
```
location = /sum {
    internal;
    content_by_lua_block {
        local args = ngx.req.get_uri_args();
        ngx.say(tonumber(args.a) + tonumber(args.b));
    }
}

location = /app/test {
    content_by_lua_block {
        local res = ngx.location.capture(
            "/sum", {args={a=3, b=8}}
        );
        ngx.say("status:", res.status, "response:", res.body);
    }
}
```

# demo03
并行调用
```
location = /sum {
    internal;
    content_by_lua_block {
        ngx.sleep(0.1);
        local args = ngx.req.get_uri_args();
        ngx.say(tonumber(args.a) + tonumber(args.b));
    }
}
location = /sub {
    internal;
    content_by_lua_block {
        ngx.sleep(0.1);
        local args = ngx.req.get_uri_args();
        ngx.say(tonumber(args.a) - tonumber(args.b));
    }
}
location = /app/test {
    content_by_lua_block {
        local start_time = ngx.now();
        local res1, res2 = ngx.location.capture_multi ({
            {"/sum", {args={a=3, b=8}}},
            {"/sub", {args={a=3, b=8}}}
        });
        ngx.say("status1:", res1.status, "response1:", res1.body);
        ngx.say("status2:", res2.status, "response2:", res2.body);
        ngx.say("time sed:", ngx.now() - start_time);
    }
}
```

# demo04
从uri和body中获取form参数  
curl -v -d "pa=4&pb=5" "http://192.168.37.85:6699/app/test?ua=1&ub=3"  
```
location /app/test {
    content_by_lua_block {
        local args_get = ngx.req.get_uri_args()
        for k, v in pairs(args_get) do
            ngx.say('get uri key:', k, ' v:', v)
        end
        ngx.req.read_body()
        local args_post = ngx.req.get_post_args()
        for k, v in pairs(args_post) do
            ngx.say('get post key:', k, ' v:', v)
        end
    }
}
```

# demo05
内部location处理  
ngx.encode_args    Encode the Lua table to a query args string according to the URI encoded rules.
```
location /print {
    internal;
    content_by_lua_block {
        local args_get = ngx.req.get_uri_args()
        for k, v in pairs(args_get) do
            ngx.say('get uri key:', k, ' v:', v)
        end
        ngx.req.read_body()
        local args_post = ngx.req.get_post_args()
        for k, v in pairs(args_post) do
            ngx.say('get post key:', k, ' v:', v)
        end
    }
}
location /app/test {
    content_by_lua_block {
        local res = ngx.location.capture (
            '/print',
            {
                method = ngx.HTTP_POST,
                args = ngx.encode_args({a = 1, b = '2'}),
                body = ngx.encode_args({c = 3, d = 4})
            }
        )
        ngx.say('status: ', res.status, ' body:', res.body)
    }
}
```

# demo06
全局配置读取body  不推荐
```
    lua_need_request_body on;
```
局部读取body  
```
location /app/test {
    content_by_lua_block {
        ngx.req.read_body()
        local data = ngx.req.get_body_data();
        ngx.say('echo ', data)
    }
}
```

# demo07
```
location /app/test {
    content_by_lua_block {
        ngx.say('hello, ')
        ngx.flush()
        ngx.sleep(5)
        ngx.say('world')
    }
}
```







